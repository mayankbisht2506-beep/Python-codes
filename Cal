import numpy as np
import pandas as pd
from astropy.cosmology import Planck18
import matplotlib.pyplot as plt
import requests
import io

# 1. Load the Pantheon+ Dataset directly from GitHub
# URL to the raw Pantheon+SH0ES.dat file (Official Repository)
url = "https://raw.githubusercontent.com/PantheonPlusSH0ES/DataRelease/main/Pantheon%2B_Data/4_DISTANCES_AND_COVAR/Pantheon%2BSH0ES.dat"

print("Downloading Pantheon+ data from online repository...")
try:
    # Fetch the content from the URL
    response = requests.get(url)
    response.raise_for_status()  # Check for download errors

    # Read the data into pandas (using whitespace as separator)
    # The file usually contains 'zHD' (redshift) and 'MU_SH0ES' (Distance Modulus)
    df = pd.read_csv(io.StringIO(response.text), sep=r'\s+')

    print(f"Successfully loaded {len(df)} supernovae.")

except Exception as e:
    print(f"Error downloading data: {e}")
    # Fallback to dummy data if internet fails, just to show the logic works
    df = pd.DataFrame({'zHD': np.linspace(0.01, 2.3, 1701), 'MU_SH0ES': np.zeros(1701)})

# 2. Define the Planck Baseline (Early Universe)
# We calculate what the magnitude SHOULD be if the universe stayed "Stiff" (Planck parameters)
def get_planck_mu(z):
    # Luminosity distance in Mpc
    # Handle z=0 to avoid log(0) errors
    if z <= 0:
        return 0
    d_L = Planck18.luminosity_distance(z).value
    # Distance modulus formula: 5 * log10(d_L) + 25
    return 5 * np.log10(d_L) + 25

# Calculate Planck prediction for every supernova
df['mu_Planck'] = df['zHD'].apply(get_planck_mu)

# 3. Calculate Residuals
# The file column for distance modulus is usually 'MU_SH0ES'
df['residual'] = df['MU_SH0ES'] - df['mu_Planck']

# 4. Define the NEW Split-Sample Cutoff (Updated to 0.65)
Z_CUTOFF = 0.65

# 5. Analyze the "Soft Vacuum" Bin (z > 0.65)
soft_bin = df[df['zHD'] > Z_CUTOFF]
stiff_bin = df[df['zHD'] < 0.5] # Baseline anchors

if len(soft_bin) > 0:
    mean_residual_soft = soft_bin['residual'].mean()
    std_error_soft = soft_bin['residual'].std() / np.sqrt(len(soft_bin))
    sigma_significance = abs(mean_residual_soft / std_error_soft)

    # 6. Output Results
    print(f"\n--- RESULTS FOR z > {Z_CUTOFF} ---")
    print(f"Number of Supernovae (N): {len(soft_bin)}")
    print(f"Mean Residual (Signal): {mean_residual_soft:.4f} mag")
    print(f"Standard Error: {std_error_soft:.4f}")
    print(f"Significance: {sigma_significance:.2f} Sigma")

    if mean_residual_soft < 0:
        print("CONCLUSION: The Late Universe is systematically BRIGHTER than Planck prediction.")
        print(f"Magnitude Excess: {mean_residual_soft:.4f} (Matches Geometric Prediction)")
    else:
        print("CONCLUSION: No brightening observed.")
else:
    print("No data found in the high-redshift bin.")
